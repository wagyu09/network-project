# 네트워크 분석 기반 주식 포트폴리오 구성 프로젝트

## 1. 프로젝트 개요 (Introduction)

이 프로젝트는 **주가 데이터로부터 네트워크를 구성**하고, 그것으로부터 포트폴리오를 구성하는 것이 투자 성과에 어떤 영향을 미치는지 분석하는 것을 목표로 합니다.

단순히 개별 주식의 가격 변동만 보는 것을 넘어, **주식들 간의 상호 연관성**을 네트워크 형태로 시각화하고 분석함으로써 새로운 투자 전략의 유효성을 검증합니다.

핵심 아이디어는 다음과 같습니다.
> 시장 전체의 공통된 움직임을 제외했을 때, 주식들 사이에 나타나는 순수한 연관성을 바탕으로 네트워크를 구축하고, Degree Centrality 등의 지표를 이용하여 포트폴리오를 구성하면 어떤 성과 차이가 나타날까?

이 가설을 검증하기 위해, 프로젝트는 **S&P 500** 종목을 대상으로 데이터를 수집하고, 분기별로 네트워크를 구축하며, 구성된 포트폴리오의 성과를 과거 데이터를 통해 시뮬레이션(백테스팅)합니다.

---

## 2. 분석 방법론 (Methodology)

본 프로젝트는 아래와 같은 단계별 파이프라인을 통해 체계적으로 분석을 수행합니다.

### 1단계: 데이터 수집 (Data Collection)
- **분석 대상**: 미국 S&P 500 지수에 포함된 종목
- **데이터 소스**: `yfinance` 라이브러리를 통해 야후 파이낸스(Yahoo Finance)에서 주가 데이터를 가져옵니다.
- **수집 항목**: 각 종목의 일별 시가, 고가, 저가, 종가, 거래량 및 S&P 500 지수(^GSPC) 데이터

### 2단계: 네트워크 구축 (Network Construction)

#### 핵심 개념: 시장 잔차 상관관계 (Market Residual Correlation)
주식 시장의 모든 종목은 시장 전체의 흐름(예: 경제 호황, 불황)에 따라 함께 오르거나 내리는 경향이 있습니다. 이는 개별 기업 간의 진정한 관계를 파악하는 데 방해가 될 수 있습니다.

따라서 저희는 이 **"시장 효과"를 통계적으로 제거**하여, 각 주식이 시장과 무관하게 움직이는 고유한 변동성, 즉 **잔차(Residual)**를 계산합니다. 그리고 이 잔차들 사이의 상관관계를 계산하여 네트워크를 구축합니다.

이렇게 만들어진 네트워크의 연결선(엣지)은 두 기업이 시장 상황과 관계없이 얼마나 유사하게 움직이는지를 나타내는 순수한 관계라고 해석할 수 있습니다.

#### 과정:
1.  **시장 효과 분리**: CAPM 모델을 기반으로 시장 수익률 대비 개별 주식 수익률의 민감도(베타)를 계산하여 시장 효과를 분리합니다.
2.  **잔차 계산**: 실제 주식 수익률에서 시장 효과에 따른 예측 수익률을 빼서 잔차를 구합니다.
3.  **상관관계 계산**: 모든 주식 쌍(pair)에 대해 잔차들 간의 피어슨 상관관계를 계산합니다.
4.  **엣지 필터링**: 계산된 상관관계가 통계적으로 유의미한지 t-검정을 통해 확인하고, 유의미한 연결(엣지)만을 남겨 최종 네트워크를 완성합니다.

### 3단계: 네트워크 분석 및 포트폴리오 구성 (Network Analysis & Portfolio Construction)

1.  **커뮤니티 탐지 (Community Detection)**
    - 완성된 네트워크 안에서 서로 밀접하게 연결된 주식들의 그룹, 즉 **커뮤니티(군집)**를 찾아냅니다. (Louvain 알고리즘 사용)
    - 이는 주로 비슷한 산업군이나 서로 강하게 연결된 기업들로 구성되는 경향이 있습니다.

2.  **중심성 분석 (Centrality Analysis)**
    - 각 주식이 네트워크(또는 커뮤니티) 내에서 얼마나 많은 연결을 가지며 중심적인 역할을 하는지를 나타내는 **Degree Centrality**을 계산합니다.

3.  **포트폴리오 구성 전략**
    - 각 커뮤니티마다 **가장 중심성이 높은 주식**과 **가장 중심성이 낮은 주식**을 하나씩 선택합니다.
    - 이렇게 선택된 주식들을 모아 두 종류의 전략 포트폴리오를 만듭니다.
      - **최대 중심성 포트폴리오**: 각 커뮤니티의 '핵심' 주식들로 구성
      - **최소 중심성 포트폴리오**: 각 커뮤니티의 '외곽' 주식들로 구성
    - 비교 분석을 위해, 전체 주식 중에서 무작위로 종목을 선택하여 다수의 **무작위 포트폴리오**도 함께 구성합니다.
    - (이는 현재 테스트 단계로 다른 구성 방식도 추가할 예정입니다.)

### 4단계: 백테스팅 및 성과 분석 (Backtesting & Performance Analysis)
- **롤링 윈도우 방식**: 분석 기간을 분기별로 나누어 진행합니다.
  - **1분기 데이터**로 네트워크를 구축하고 포트폴리오를 구성합니다.
  - 구성된 포트폴리오를 **직후 1분기 동안** 운용했을 때의 성과를 측정합니다.
  - 이 과정을 한 분기씩 이동하며 전체 기간에 대해 반복합니다.
- **성과 측정 지표**:
  - **누적 수익률 (Cumulative Return)**: 총 투자 기간 동안의 수익률
  - **변동성 (Volatility)**: 수익률의 변동 위험 (연율화 기준)
  - **샤프 지수 (Sharpe Ratio)**: 위험 대비 수익성 지표
  - **최대 낙폭 (Max Drawdown, MDD)**: 최고점 대비 최대 하락률
- **최종 분석**: 전략 포트폴리오(최대/최소 중심성)의 평균 성과를 수많은 무작위 포트폴리오의 평균 성과와 비교하여, 저희의 전략이 우연보다 뛰어난 성과를 보이는지 통계적으로 분석합니다.

---

## 3. 프로젝트 구조 (Project Structure)

```
/
├── run.py                      # 전체 분석 파이프라인을 실행하는 메인 스크립트
├── analyze_results.py          # 모든 분기별 결과를 취합하여 최종 리포트를 생성하는 스크립트
├── config.py                   # 분석 기간, 파일 경로, 파라미터 등 주요 설정을 관리하는 파일
├── requirements.txt            # 프로젝트 실행에 필요한 라이브러리 목록
├── README.md                   # 프로젝트 설명 파일 (현재 문서)
│
├── pipeline/                   # 데이터 처리 및 분석의 핵심 로직을 담은 모듈 디렉토리
│   ├── data_loader.py          # 주가, S&P500 티커, 시장 지수 데이터 로드
│   ├── corr_calculator.py      # 시장 잔차 및 상관관계 계산
│   ├── threshold.py            # 통계적 유의성에 기반한 네트워크 엣지 필터링
│   ├── network_analysis.py     # 중심성 계산, 커뮤니티 탐지, 네트워크 시각화
│   ├── portfolio.py            # 포트폴리오 구성 및 성과 지표 계산
│   └── utils.py                # 날짜 변환 등 보조 함수
│
└── tests/                      # 분석 결과가 저장되는 디렉토리
    ├── Test_01_(2020Q1-2020Q2)/ # 각 분기별 테스트 결과를 담는 하위 폴더
    │   ├── backtest_results.csv  # 포트폴리오별 성과 지표
    │   ├── correlation_matrix.csv# 잔차 상관관계 행렬
    │   ├── gephi_edges.csv       # Gephi 시각화용 엣지 리스트
    │   └── network_visualization.png # 네트워크 시각화 이미지
    └── ...
```

---

## 4. 사용 방법 (How to Use)

### 1. 사전 준비 (Prerequisites)
- Python (3.9 이상 권장)
- pip (Python 패키지 설치 도구)

### 2. 설치 (Installation)
1.  이 프로젝트를 컴퓨터에 다운로드하거나 복제(clone)합니다.
2.  터미널(명령 프롬프트)을 열고 프로젝트 폴더로 이동합니다.
3.  아래 명령어를 실행하여 필요한 라이브러리를 모두 설치합니다.
    ```bash
    pip install -r requirements.txt
    ```

### 3. 설정 (Configuration)
- `config.py` 파일을 열어 분석 기간, 제외할 종목, 테스트 파라미터 등을 필요에 맞게 수정할 수 있습니다.

### 4. 실행 (Execution)
1.  **분석 파이프라인 실행**:
    - 터미널에서 아래 명령어를 실행하면 전체 기간에 대한 롤링 윈도우 백테스팅이 시작됩니다.
    - 각 분기별 분석 결과는 `tests/` 폴더 내에 순차적으로 저장됩니다.
    ```bash
    python run.py
    ```

2.  **최종 결과 리포트 생성**:
    - 위 `run.py` 실행이 완료된 후, 아래 명령어를 실행합니다.
    - `tests/` 폴더에 저장된 모든 분기별 결과를 취합하여, 전략 포트폴리오들의 전체 기간 평균 성과를 계산하고 터미널에 출력합니다.
    - 최종 요약본은 `final_summary_report.csv` 파일로 저장됩니다.
    ```bash
    python analyze_results.py
    ```

---

## 5. 결과 해석 (Interpreting the Results)

- **`tests/` 폴더**: 각 분기별 상세 분석 결과가 담겨 있습니다. 특히 `network_visualization.png`를 통해 매 분기 주식 시장 네트워크가 어떻게 변화하는지 시각적으로 확인할 수 있습니다.
- **`final_summary_report.csv`**: 이 파일이 최종 결론을 담고 있습니다. 각 전략 포트폴리오의 평균 성과 지표와 함께 **`Avg_Random_Outperformance_Rate`** 라는 중요한 지표를 제공합니다.
  - 이 값은 저희의 전략 포트폴리오가 무작위 포트폴리오보다 성과가 나빴던 비율의 평균을 의미합니다. 예를 들어, `Avg_Random_Outperformance_Rate (Return)` 값이 0.3이라면, 전체 기간 동안 저희 전략의 수익률이 무작위 포트폴리오 중 상위 70% 수준에 위치했다는 의미로 해석할 수 있습니다. 즉, 이 값이 낮을수록 전략의 우수성이 높다고 볼 수 있습니다.
